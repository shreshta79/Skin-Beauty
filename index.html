<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form tracking test</title>

  <!-- (Keep your gtag / GTM snippets as needed) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-33N694B2D0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-33N694B2D0');
  </script>

  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-P6LB64KL');</script>
</head>
<body>

  <!-- Example form: make sure your real form has id="contactForm" -->
  <form id="contactForm" action="https://example.com/submit" method="post">
    <label>
      Name: <input name="name" required />
    </label>
    <button type="submit">Send</button>
  </form>

  <script>
  (function () {
    // Use the explicit ID — ensure your real form has id="contactForm"
    var form = document.getElementById('contactForm');
    if (!form) {
      console.warn('contactForm not found — add id="contactForm" to your form.');
      return;
    }

    // Helper: get button text in older browsers if e.submitter is not supported
    function getSubmitterText(e) {
      try {
        if (e && e.submitter && e.submitter.innerText) return e.submitter.innerText.trim();
      } catch (err) {}
      // fallback: the currently focused element when submit was triggered
      try {
        var active = document.activeElement;
        if (active && (active.tagName === 'BUTTON' || (active.tagName === 'INPUT' && (active.type === 'submit')))) {
          return (active.innerText || active.value || '').trim();
        }
      } catch (err) {}
      return '';
    }

    var handling = false; // prevent double handling

    form.addEventListener('submit', function (e) {
      if (handling) {
        // allow normal submit if we've already handled once
        return;
      }
      handling = true;

      // capture useful data early
      var submitterText = getSubmitterText(e);
      var payload = {
        event: 'contact_form_submit',   // clear event name (recommended)
        formId: form.id || '',
        formName: form.getAttribute('name') || '',
        submitButtonText: submitterText || '',
        ts: new Date().toISOString()
      };

      // debug: show what we'll push (remove these logs in production)
      console.log('[FORM TRACK] push to dataLayer:', payload);

      // Ensure dataLayer exists and push
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(payload);

      // Preferred: try sendBeacon to notify your server (optional)
      // If you need to notify your own endpoint reliably before navigation, uncomment and set URL
      // try {
      //   var beacon = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      //   navigator.sendBeacon('/your-beacon-endpoint', beacon);
      // } catch (err) { /* ignore sendBeacon errors */ }

      // Prevent immediate navigation so GTM has a short window to react to the push.
      e.preventDefault();

      // Wait short time then submit programmatically.
      // 200-300ms is usually enough for GTM to capture the push. Increase if you have heavy tags.
      setTimeout(function () {
        // Remove the listener to avoid recursion, then submit
        form.removeEventListener('submit', arguments.callee);
        // Programmatic submit (will navigate)
        try {
          form.submit();
        } catch (err) {
          // last-resort: allow natural submit
          console.warn('Programmatic submit failed, trying to re-enable native submit.');
          var temp = document.createElement('input');
          temp.type = 'submit';
          temp.style.display = 'none';
          form.appendChild(temp);
          temp.click();
        }
      }, 250);
    }, false);
  })();
  </script>
</body>
</html>
